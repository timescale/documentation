import { PG, SELF_LONG, CAGG_CAP } from '/snippets/vars.mdx';

1. **Configure your self-hosted {PG} deployment**

   1. Open `postgresql.conf`.

      The {PG} configuration files are usually located in:

      - Docker: `/home/postgres/pgdata/data/`
      - Linux: `/etc/postgresql/<version>/main/` or `/var/lib/pgsql/<version>/data/`
      - MacOS: `/opt/homebrew/var/postgresql@<version>/`
      - Windows: `C:\Program Files\PostgreSQL\<version>\data\`

   2. Enable logical replication.

      Modify the following settings in `postgresql.conf`:

      ```ini
      wal_level = logical
      max_replication_slots = 10
      max_wal_senders = 10
      ```

   3. Open `pg_hba.conf` and enable host replication.

      To allow replication connections, add the following:

      ```
      local replication debezium                         trust  
      ```
      This permission is for the `debezium` {PG} user running on a local or Docker deployment. For more about replication 
      permissions, see [Configuring {PG} to allow replication with the Debezium connector host][debezium-replication-permissions].

   4. Restart {PG}.


2. **Connect to your {SELF_LONG} instance**

   Use [`psql`][psql-connect]. 

3. **Create a Debezium user in {PG}**

   Create a user with the `LOGIN` and `REPLICATION` permissions:

    ```sql
    CREATE ROLE debezium WITH LOGIN REPLICATION PASSWORD '<debeziumpassword>';
    ```

4. **Enable a replication spot for Debezium**

   1. Create a table for Debezium to listen to:

      ```sql
      CREATE TABLE accounts (created_at TIMESTAMPTZ DEFAULT NOW(),
       name TEXT,
       city TEXT);
      ```

   2. Turn the table into a hypertable:

      ```sql
      SELECT create_hypertable('accounts', 'created_at');
      ```

      Debezium also works with [{CAGG_CAP}s][caggs].

   3. Create a publication and enable a replication slot:
  
      ```sql
      CREATE PUBLICATION dbz_publication FOR ALL TABLES WITH (publish = 'insert, update');
      ```
      
[caggs]: /use-timescale/continuous-aggregates
[debezium-replication-permissions]: https://debezium.io/documentation/reference/3.2/connectors/postgresql.html#postgresql-host-replication-permissions
[psql-connect]: /integrations/integrate/psql/#connect-to-your-service
