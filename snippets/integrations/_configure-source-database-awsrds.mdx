import EnableReplication from '/snippets/integrations/_enable-replication.mdx';
import { PG, PG_CONNECTOR } from '/snippets/vars.mdx';

Updating parameters on a {PG} instance will cause an outage. Choose a time that will cause the least issues to tune this database.

1. **Tune the Write Ahead Log (WAL) on the RDS/Aurora {PG} source database**

   1. In [https://console.aws.amazon.com/rds/home#databases:][aws-databases],
      select the RDS instance to migrate.

   2. Click `Configuration`, scroll down and note the `DB instance parameter group`, then click `Parameter Groups`

      ![Create security rule to enable RDS EC2 connection](https://assets.timescale.com/docs/images/migrate/awsrds-parameter-groups.png)

   3. Click `Create parameter group`, fill in the form with the following values, then click `Create`.
      - **Parameter group name** - whatever suits your fancy.
      - **Description** - knock yourself out with this one.
      - **Engine type** - `PostgreSQL`
      - **Parameter group family** - the same as `DB instance parameter group` in your `Configuration`.
   4. In `Parameter groups`, select the parameter group you created, then click `Edit`.
   5. Update the following parameters, then click `Save changes`.
      - `rds.logical_replication` set to `1`: record the information needed for logical decoding.
      - `wal_sender_timeout` set to `0`: disable the timeout for the sender process.

   6. In RDS, navigate back to your [databases][aws-databases], select the RDS instance to migrate, and click `Modify`.

   7. Scroll down to `Database options`, select your new parameter group, and click `Continue`.
   8. Click `Apply immediately` or choose a maintenance window, then click `Modify DB instance`.

      Changing parameters will cause an outage. Wait for the database instance to reboot before continuing.
   9. Verify that the settings are live in your database.

2. **Create a user for the {PG_CONNECTOR} and assign permissions**

   1. Create `<pg connector username>`:

      ```sql
      psql $SOURCE -c "CREATE USER <pg connector username> PASSWORD '<password>'"
      ```

      You can use an existing user. However, you must ensure that the user has the following permissions.

   2. Grant permissions to create a replication slot:

      ```sql
      psql $SOURCE -c "GRANT rds_replication TO <pg connector username>"
      ```

   3. Grant permissions to create a publication:

      ```sql
      psql $SOURCE -c "GRANT CREATE ON DATABASE <database name> TO <pg connector username>"
      ```

   4. Assign the user permissions on the source database:

      ```sql
      psql $SOURCE <<EOF
      GRANT USAGE ON SCHEMA "public" TO <pg connector username>;
      GRANT SELECT ON ALL TABLES IN SCHEMA "public" TO <pg connector username>;
      ALTER DEFAULT PRIVILEGES IN SCHEMA "public" GRANT SELECT ON TABLES TO <pg connector username>;
      EOF
      ```

      If the tables you are syncing are not in the `public` schema, grant the user permissions for each schema you are syncing:
      ```sql
      psql $SOURCE <<EOF
      GRANT USAGE ON SCHEMA <schema> TO <pg connector username>;
      GRANT SELECT ON ALL TABLES IN SCHEMA <schema> TO <pg connector username>;
      ALTER DEFAULT PRIVILEGES IN SCHEMA <schema> GRANT SELECT ON TABLES TO <pg connector username>;
      EOF
      ```

   5. On each table you want to sync, make `<pg connector username>` the owner:

      ```sql
      psql $SOURCE -c 'ALTER TABLE <table name> OWNER TO <pg connector username>;'
      ```
      You can skip this step if the replicating user is already the owner of the tables.

3. **Enable replication `DELETE` and `UPDATE` operations**

   <EnableReplication />

[aws-databases]: https://console.aws.amazon.com/rds/home#databases:
